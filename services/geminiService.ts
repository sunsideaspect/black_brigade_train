import { GoogleGenAI, Type } from "@google/genai";
import { TrainingFormData, TrainingPlanResponse } from "../types";

// Жорсткий, реалістичний опис тем для умов повномасштабної війни
const TOPIC_DETAILS: Record<string, string> = {
  // --- Інженерно-саперна справа ---
  "Фортифікація: Бліндажі та 'Лисячі нори'": "Правила трьох накатів. Гідроізоляція підручними засобами. Як швидко заритися, коли над головою висить дрон. Обладнання перекритих щілин.",
  "Інженерні загородження (МЗП/Дріт)": "Встановлення МЗП (Малопомітна Перешкода/путанка). Спіраль Бруно. Експрес-загородження. Як не заплутатися самому під час відходу.",
  "ВНП РФ та Мінна безпека (ПМН/ОЗМ)": "ПМН-4, ПОМ-3 'Медальйон', ОЗМ-72. Пастки МЛ-7/МЛ-8. Правило: 'Не знаєш - не чіпай'.",
  "Дистанційне мінування (Земледелие/ПФМ)": "Як виглядають касети КПТМ. 'Пелюстки' (ПФМ-1) в траві. ПОМ-2 'Отек'. Звук відстрілу касет. Дії групи при потраплянні під дистанційне мінування.",
  "Пророблення проходів (Тропи)": "Створення піших проходів. Робота з щупом та кішкою. Маркування 'стежки життя' для піхоти, яке не світиться для ворога.",
  "Підривна справа (Розрахунок зарядів)": "В'язання запальних трубок (ЗТП). Розрахунок тротилу. Електричний спосіб підривання. ТБ при підриві.",

  // --- Медицина ---
  "Самодопомога в червоній зоні": "Турнікет собі одною рукою лежачи. Контроль кровотечі. Дії, коли медик не може підійти.",
  "Робота з пораненням під обстрілом": "Перев'язка брудними руками. Тампонада. Знебол. Евакуація без нош.",
  "Переміщення пораненого (волокуші/стропи)": "Евакуація волокушами повзком. Робота стропою з укриття. 'Ривок' тіла в безпечну зону.",

  // --- Тактика / Виживання ---
  "Маскування від 'Тепла' (Mavic 3T)": "Як працює тепловізор. Антитеплові накидки. Використання рельєфу. Чому не можна дивитися вгору відкритим обличчям.",
  "Окопування лежачи (під вогнем)": "Швидке риття одиночного окопу лежачи. Маскування свіжої землі. Захист від осколків.",
  "Антидронові перекриття (Бліндажі)": "Сітки-рабиці, 'мангали'. Захист входу в бліндаж. L-подібні входи.",
  "Нічна робота (ПНБ/Тепловізори)": "Рух вночі. Світломаскування рацій. Робота 'двійками' в темряві.",

  // --- БПЛА (Реалії) ---
  "Захист від скидів (Мавік/Аутел)": "Тактика 'зависання' дрона. Характерний звук перед скидом. Чому не можна бігти по прямій. Використання стовбурів дерев як захисту.",
  "Дії при атаці FPV (Маневр/Укриття)": "Звук наближення (вищання). Різкий маневр в останній момент. Падіння обличчям в землю (захист ніг та паху). РЕБ 'рюкзак' (якщо є).",
  "Робота під 'Пташкою' (Коригування по рації)": "Взаємодія з пілотом. Сліпа довіра командам: 'Стій', 'Лівіше', 'Чисто'. Пілот бачить міни на поверхні краще за тебе.",
  "Акустичне виявлення (На слух)": "Як на слух відрізнити: Мавік (дзижчить), FPV (вищить як болгарка), Крило (гуде як мопед). Визначення напрямку та відстані.",

  // --- Зв'язок ---
  "Радіодисципліна та шифрування": "Короткі команди. Таблиця позивних. Чому ворог слухає 'Баофенги'.",
  "Прошивка та аварійне скидання": "Як стерти рацію при загрозі полону."
};

export const generateTrainingPlan = async (data: TrainingFormData): Promise<TrainingPlanResponse> => {
  const apiKey = process.env.API_KEY;
  if (!apiKey) {
    throw new Error("API Key is missing. Please ensure process.env.API_KEY is set.");
  }

  const ai = new GoogleGenAI({ apiKey });

  // Формуємо детальний опис обраних тем
  const selectedFocusDetails = data.focusAreas.map(topic => {
    const detail = TOPIC_DETAILS[topic] || "Тема важлива для виживання. Акцент на практиці.";
    return `ТЕМА: ${topic}. \nСУТЬ: ${detail}`;
  }).join("\n    ");

  const prompt = `
    ТИ: Досвідчений головний сержант інженерно-саперної роти ЗСУ. 
    ЗАВДАННЯ: Скласти розклад занять.
    
    Вхідні дані:
    - Днів: ${data.durationDays}.
    - Рівень: ${data.experienceLevel}.
    - ОБРАНІ ТЕМИ:
    ${selectedFocusDetails}
    - Коментар: ${data.customNotes || "Зроби з них людей."}

    КРИТИЧНІ ВИМОГИ ДО РОЗКЛАДУ:
    1. МОНОЛІТНІ ДНІ: Групуй заняття (Медицина окремо, Інженерка окремо).
    
    2. ІНФОРМАЦІЯ (Google Grounding):
       - У розділі "instructorTips" ВИКОРИСТОВУЙ ПОШУК (googleSearch).
       - Знайди актуальні ТТХ, методички, поради.
       - Випиши СУТЬ (як AI Overview). Якщо є лінк - дай його.

    3. КОНТРОЛЬ ЗНАНЬ (ОБОВ'ЯЗКОВО!):
       - Для кожного заняття додай масив "questions".
       - Це РІВНО 5 "підлих" питань, щоб перевірити, чи уважно слухали.
       - Питання мають бути практичними, а не теоретичними.
       - Додай коротку правильну відповідь.
       Приклад:
       Питання: "Який час самоліквідації у ПОМ-3?" 
       Відповідь: "Від 8 до 24 годин (але може не спрацювати, не підходити!)."

    4. ЗМІСТ: Суворий, без води. Тільки те, що рятує життя.

    Мова: Українська (військова).
  `;

  const response = await ai.models.generateContent({
    model: 'gemini-3-flash-preview',
    contents: prompt,
    config: {
      tools: [{googleSearch: {}}], 
      systemInstruction: "Ти бойовий інструктор. Твій план має містити не лише теми, а й конкретні матеріали (знайдені в Google) та РІВНО 5 контрольних питань до кожного заняття.",
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          title: { type: Type.STRING },
          overview: { type: Type.STRING },
          days: {
            type: Type.ARRAY,
            items: {
              type: Type.OBJECT,
              properties: {
                dayNumber: { type: Type.INTEGER },
                theme: { type: Type.STRING },
                objectives: {
                  type: Type.ARRAY,
                  items: { type: Type.STRING }
                },
                safetyNotes: { type: Type.STRING },
                schedule: {
                  type: Type.ARRAY,
                  items: {
                    type: Type.OBJECT,
                    properties: {
                      time: { type: Type.STRING },
                      subject: { type: Type.STRING },
                      description: { type: Type.STRING },
                      instructorTips: { 
                        type: Type.ARRAY,
                        items: { type: Type.STRING },
                        description: "Концентрат знань з Google Search."
                      },
                      questions: {
                        type: Type.ARRAY,
                        items: {
                          type: Type.OBJECT,
                          properties: {
                            question: { type: Type.STRING },
                            answer: { type: Type.STRING }
                          },
                          required: ["question", "answer"]
                        },
                        description: "Список з 5 контрольних питань."
                      },
                      type: { 
                        type: Type.STRING, 
                        enum: ["Theory", "Practice", "Drill"]
                      }
                    },
                    required: ["time", "subject", "description", "instructorTips", "type", "questions"]
                  }
                }
              },
              required: ["dayNumber", "theme", "objectives", "safetyNotes", "schedule"]
            }
          }
        },
        required: ["title", "overview", "days"]
      }
    }
  });

  const text = response.text;
  if (!text) {
    throw new Error("No response from AI");
  }

  try {
    return JSON.parse(text) as TrainingPlanResponse;
  } catch (e) {
    console.error("Failed to parse JSON", e);
    throw new Error("Received invalid format from AI generator.");
  }
};